<!-- AI Applicant Matching Section -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-robot me-2"></i>AI Applicant Matching
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="refreshMatchingResults()">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
        <button type="button" class="btn btn-sm btn-primary" onclick="openMatchingPreferences()">
            <i class="fas fa-cog me-1"></i> Preferences
        </button>
    </div>
</div>

<!-- Jobs with Matching Applicants -->
<div class="row" id="matchingResults">
    <!-- Results will be loaded here -->
</div>

<!-- Loading State -->
<div id="matchingLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading matching results...</span>
    </div>
    <p class="mt-3 text-muted">AI is analyzing applicants for your jobs...</p>
</div>

<!-- Empty State -->
<div id="matchingEmpty" class="text-center py-5" style="display: none;">
    <i class="fas fa-search fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">No matching applicants found</h4>
    <p class="text-muted">Try adjusting your matching preferences or check back later for new applicants.</p>
</div>

<!-- Matching Preferences Modal -->
<div class="modal fade" id="matchingPreferencesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Matching Preferences
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="matchingPreferencesForm">
                    <div class="mb-3">
                        <label for="minScore" class="form-label">Minimum Matching Score</label>
                        <input type="range" class="form-range" id="minScore" min="0" max="100" value="30">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">More matches</small>
                            <small class="text-muted">Better matches</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="limit" class="form-label">Applicants per Job</label>
                        <select class="form-select" id="limit">
                            <option value="10">10 applicants</option>
                            <option value="20" selected>20 applicants</option>
                            <option value="50">50 applicants</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Matching Criteria</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="skillsMatch" checked>
                            <label class="form-check-label" for="skillsMatch">
                                Skills & Technical Requirements
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="experienceMatch" checked>
                            <label class="form-check-label" for="experienceMatch">
                                Experience Level
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="educationMatch" checked>
                            <label class="form-check-label" for="educationMatch">
                                Education & Degree
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fieldMatch" checked>
                            <label class="form-check-label" for="fieldMatch">
                                Industry & Field
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMatchingPreferences()">Save Preferences</button>
            </div>
        </div>
    </div>
</div>

<!-- Applicant Detail Modal -->
<div class="modal fade" id="applicantDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>Applicant Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="applicantDetailContent">
                <!-- Applicant details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="contactApplicant()">
                    <i class="fas fa-envelope me-1"></i> Contact
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.matching-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.matching-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.matching-card.high-match {
    border-left-color: #28a745;
}

.matching-card.medium-match {
    border-left-color: #ffc107;
}

.matching-card.low-match {
    border-left-color: #6c757d;
}

.matching-score {
    font-size: 1.5rem;
    font-weight: bold;
}

.matching-score.high {
    color: #28a745;
}

.matching-score.medium {
    color: #ffc107;
}

.matching-score.low {
    color: #6c757d;
}

.applicant-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.matching-reason {
    font-size: 0.85rem;
    color: #6c757d;
}

.skill-tag {
    background-color: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    margin: 0.125rem;
}
</style>

<script>
let currentMatchingData = {};
let matchingPreferences = {
    minScore: 30,
    limit: 20,
    skillsMatch: true,
    experienceMatch: true,
    educationMatch: true,
    fieldMatch: true
};

// Load matching results on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMatchingResults();
});

// Load all matching results
async function loadMatchingResults() {
    try {
        showLoading();
        
        const response = await fetch('/business/api/matching-applicants/all', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentMatchingData = result.data.recommendations;
            displayMatchingResults(currentMatchingData);
        } else {
            showError('Failed to load matching results');
        }
    } catch (error) {
        console.error('Error loading matching results:', error);
        showError('Error loading matching results');
    }
}

// Display matching results
function displayMatchingResults(recommendations) {
    const container = document.getElementById('matchingResults');
    container.innerHTML = '';
    
    const jobIds = Object.keys(recommendations);
    
    if (jobIds.length === 0) {
        showEmpty();
        return;
    }
    
    jobIds.forEach(jobId => {
        const jobData = recommendations[jobId];
        if (jobData.applicants && jobData.applicants.length > 0) {
            const jobCard = createJobCard(jobData);
            container.appendChild(jobCard);
        }
    });
    
    hideLoading();
}

// Create job card with matching applicants
function createJobCard(jobData) {
    const col = document.createElement('div');
    col.className = 'col-lg-6 mb-4';
    
    const card = document.createElement('div');
    card.className = 'card matching-card';
    
    // Determine match level based on top applicant score
    const topScore = jobData.applicants[0]?.matchingScore || 0;
    let matchClass = 'low-match';
    if (topScore >= 70) matchClass = 'high-match';
    else if (topScore >= 50) matchClass = 'medium-match';
    
    card.classList.add(matchClass);
    
    card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-0">${jobData.job.title}</h6>
                <small class="text-muted">${jobData.job.field} • ${jobData.job.type}</small>
            </div>
            <span class="badge bg-primary">${jobData.applicants.length} Matches</span>
        </div>
        <div class="card-body">
            <div class="applicant-list">
                ${jobData.applicants.slice(0, 3).map(applicant => createApplicantRow(applicant)).join('')}
                ${jobData.applicants.length > 3 ? `
                    <div class="text-center mt-2">
                        <small class="text-muted">+${jobData.applicants.length - 3} more matches</small>
                    </div>
                ` : ''}
            </div>
        </div>
        <div class="card-footer">
            <button class="btn btn-sm btn-outline-primary" onclick="viewAllMatches('${jobData.job._id}')">
                View All Matches
            </button>
            <button class="btn btn-sm btn-primary" onclick="refreshJobMatches('${jobData.job._id}')">
                Refresh
            </button>
        </div>
    `;
    
    col.appendChild(card);
    return col;
}

// Create applicant row
function createApplicantRow(applicant) {
    const score = applicant.matchingScore;
    let scoreClass = 'low';
    if (score >= 70) scoreClass = 'high';
    else if (score >= 50) scoreClass = 'medium';
    
    return `
        <div class="d-flex align-items-center mb-2 p-2 bg-light rounded" onclick="viewApplicantDetail('${applicant.user._id}', '${applicant.user._id}')" style="cursor: pointer;">
            <img src="${applicant.user.avatar || '/images/default-avatar.png'}" class="applicant-avatar me-3" alt="${applicant.user.username}">
            <div class="flex-grow-1">
                <div class="fw-medium">${applicant.user.username || 'Unknown User'}</div>
                <div class="matching-reason">${applicant.matchingReasons.slice(0, 2).join(' • ')}</div>
            </div>
            <div class="text-center">
                <div class="matching-score ${scoreClass}">${score}%</div>
                <small class="text-muted">Match</small>
            </div>
        </div>
    `;
}

// View all matches for a specific job
async function viewAllMatches(jobId) {
    try {
        const response = await fetch(`/business/api/job/${jobId}/matching-applicants`);
        const result = await response.json();
        
        if (result.success) {
            // TODO: Show detailed view for all matches
            console.log('All matches for job:', result.data);
        }
    } catch (error) {
        console.error('Error loading all matches:', error);
    }
}

// View applicant detail
async function viewApplicantDetail(userId, jobId) {
    try {
        const response = await fetch(`/business/api/applicant/${userId}/profile?jobId=${jobId}`);
        const result = await response.json();
        
        if (result.success) {
            showApplicantDetail(result.data);
        }
    } catch (error) {
        console.error('Error loading applicant detail:', error);
    }
}

// Show applicant detail in modal
function showApplicantDetail(applicant) {
    const modal = document.getElementById('applicantDetailModal');
    const content = document.getElementById('applicantDetailContent');
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-4 text-center">
                <img src="${applicant.user.avatar || '/images/default-avatar.png'}" class="img-fluid rounded-circle mb-3" alt="${applicant.user.username}">
                <h5>${applicant.user.username || 'Unknown User'}</h5>
                <div class="matching-score ${applicant.matchingScore >= 70 ? 'high' : applicant.matchingScore >= 50 ? 'medium' : 'low'}">
                    ${applicant.matchingScore}% Match
                </div>
            </div>
            <div class="col-md-8">
                <h6>Matching Reasons</h6>
                <ul class="list-unstyled">
                    ${applicant.matchingReasons.map(reason => `<li><i class="fas fa-check text-success me-2"></i>${reason}</li>`).join('')}
                </ul>
                
                <h6 class="mt-3">Skills</h6>
                <div class="mb-3">
                    ${(applicant.cv.parsed_output.skills?.technical || []).map(skill => 
                        `<span class="skill-tag">${skill}</span>`
                    ).join('')}
                </div>
                
                <h6>Experience</h6>
                <p class="text-muted">
                    ${(applicant.cv.parsed_output.work_experience || []).map(exp => 
                        `<div><strong>${exp.title}</strong> at ${exp.company} (${exp.duration})</div>`
                    ).join('') || 'No experience listed'}
                </p>
                
                <h6>Education</h6>
                <p class="text-muted">
                    ${(applicant.cv.parsed_output.education || []).map(edu => 
                        `<div><strong>${edu.degree}</strong> from ${edu.school}</div>`
                    ).join('') || 'No education listed'}
                </p>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(modal).show();
}

// Refresh matching results
function refreshMatchingResults() {
    loadMatchingResults();
}

// Refresh specific job matches
async function refreshJobMatches(jobId) {
    try {
        const response = await fetch(`/business/api/job/${jobId}/matching-applicants`);
        const result = await response.json();
        
        if (result.success) {
            // Update the specific job card
            currentMatchingData[jobId] = {
                job: result.data.job,
                applicants: result.data.applicants,
                totalFound: result.data.totalFound
            };
            displayMatchingResults(currentMatchingData);
        }
    } catch (error) {
        console.error('Error refreshing job matches:', error);
    }
}

// Open matching preferences modal
function openMatchingPreferences() {
    new bootstrap.Modal(document.getElementById('matchingPreferencesModal')).show();
}

// Save matching preferences
async function saveMatchingPreferences() {
    const form = document.getElementById('matchingPreferencesForm');
    const formData = new FormData(form);
    
    matchingPreferences = {
        minScore: parseInt(document.getElementById('minScore').value),
        limit: parseInt(document.getElementById('limit').value),
        skillsMatch: document.getElementById('skillsMatch').checked,
        experienceMatch: document.getElementById('experienceMatch').checked,
        educationMatch: document.getElementById('educationMatch').checked,
        fieldMatch: document.getElementById('fieldMatch').checked
    };
    
    try {
        const response = await fetch('/business/api/matching-preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(matchingPreferences)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('matchingPreferencesModal')).hide();
            loadMatchingResults(); // Reload with new preferences
        }
    } catch (error) {
        console.error('Error saving preferences:', error);
    }
}

// Contact applicant
function contactApplicant() {
    // TODO: Implement contact functionality
    alert('Contact functionality to be implemented');
}

// UI Helper functions
function showLoading() {
    document.getElementById('matchingLoading').style.display = 'block';
    document.getElementById('matchingResults').style.display = 'none';
    document.getElementById('matchingEmpty').style.display = 'none';
}

function hideLoading() {
    document.getElementById('matchingLoading').style.display = 'none';
    document.getElementById('matchingResults').style.display = 'flex';
    document.getElementById('matchingEmpty').style.display = 'none';
}

function showEmpty() {
    document.getElementById('matchingLoading').style.display = 'none';
    document.getElementById('matchingResults').style.display = 'none';
    document.getElementById('matchingEmpty').style.display = 'block';
}

function showError(message) {
    hideLoading();
    const container = document.getElementById('matchingResults');
    container.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
        </div>
    `;
}
</script>
